(function(n){"use strict";function e(n){n.touches||(n.touches=n.originalEvent.touches)}function h(n,t){t._startY=n.touches[0].pageY;t.touchScrollTop=t.$scrollArea.scrollTop()}function c(t,i){i._curY=t.touches[0].pageY;i._moveY=i._curY-i._startY;i._moveY>0?i.direction="down":i._moveY<0&&(i.direction="up");var r=Math.abs(i._moveY);i.opts.loadUpFn!=""&&i.touchScrollTop<=0&&i.direction=="down"&&!i.isLockUp&&(t.preventDefault(),i.$domUp=n("."+i.opts.domUp.domClass),i.upInsertDOM||(i.$element.prepend('<div class="'+i.opts.domUp.domClass+'"><\/div>'),i.upInsertDOM=!0),s(i.$domUp,0),r<=i.opts.distance?(i._offsetY=r,i.$domUp.html(i.opts.domUp.domRefresh)):r>i.opts.distance&&r<=i.opts.distance*2?(i._offsetY=i.opts.distance+(r-i.opts.distance)*.5,i.$domUp.html(i.opts.domUp.domUpdate)):i._offsetY=i.opts.distance+i.opts.distance*.5+(r-i.opts.distance*2)*.2,i.$domUp.css({height:i._offsetY}))}function l(t){var i=Math.abs(t._moveY);if(t.opts.loadUpFn!=""&&t.touchScrollTop<=0&&t.direction=="down"&&!t.isLockUp){if(s(t.$domUp,300),i>t.opts.distance)t.$domUp.css({height:t.$domUp.children().height()}),t.$domUp.html(t.opts.domUp.domLoad),t.loading=!0,t.opts.loadUpFn(t);else t.$domUp.css({height:"0"}).on("webkitTransitionEnd transitionend",function(){t.upInsertDOM=!1;n(this).remove()});t._moveY=0}}function o(n){n._scrollContentHeight=n.opts.scrollArea==i?f.height():n.$element[0].scrollHeight}function s(n,t){n.css({"-webkit-transition":"all "+t+"ms",transition:"all "+t+"ms"})}var i=window,r=document,u=n(i),f=n(r),t;n.fn.dropload=function(n){return new t(this,n)};t=function(t,i){var r=this;r.$element=n(t);r.upInsertDOM=!1;r.loading=!1;r.isLockUp=!1;r.isLockDown=!1;r.isData=!0;r._scrollTop=0;r.init(i)};t.prototype.init=function(t){function s(){o.direction="up";o.$domDown.html(o.opts.domDown.domLoad);o.loading=!0;o.opts.loadDownFn(o)}var o=this;o.opts=n.extend({},{scrollArea:o.$element,domUp:{domClass:"dropload-up",domRefresh:'<div class="dropload-refresh">↓下拉刷新<\/div>',domUpdate:'<div class="dropload-update">↑释放更新<\/div>',domLoad:'<div class="dropload-load"><span class="loading"><\/span>加载中...<\/div>'},domDown:{domClass:"dropload-down",domRefresh:'<div class="dropload-refresh">↑上拉加载更多<\/div>',domLoad:'<div class="dropload-load"><span class="loading"><\/span>加载中...<\/div>',domNoData:'<div class="dropload-noData">暂无数据<\/div>'},distance:50,threshold:"",loadUpFn:"",loadDownFn:""},t);o.opts.loadDownFn!=""&&o.$element.find("."+o.opts.domDown.domClass).length===0&&(o.$element.append('<div class="'+o.opts.domDown.domClass+'">'+o.opts.domDown.domRefresh+"<\/div>"),o.$domDown=n("."+o.opts.domDown.domClass));o.opts.scrollArea==i?(o.$scrollArea=u,o._scrollContentHeight=f.height(),o._scrollWindowHeight=r.documentElement.clientHeight):(o.$scrollArea=o.opts.scrollArea,o._scrollContentHeight=o.$element[0].scrollHeight,o._scrollWindowHeight=o.$element.height());o._scrollContentHeight<=o._scrollWindowHeight&&s();u.on("resize",function(){o._scrollWindowHeight=o.opts.scrollArea==i?i.innerHeight:o.$element.height()});o.$element.on("touchstart",function(n){o.loading||(e(n),h(n,o))});o.$element.on("touchmove",function(n){o.loading||(e(n,o),c(n,o))});o.$element.on("touchend",function(){o.loading||l(o)});o.$scrollArea.on("scroll",function(){o._scrollTop=o.$scrollArea.scrollTop();o._threshold=o.opts.threshold===""?Math.floor(o.$domDown.height()/3):o.opts.threshold;o.opts.loadDownFn!=""&&!o.loading&&!o.isLockDown&&o._scrollContentHeight-o._threshold<=o._scrollWindowHeight+o._scrollTop&&s()})};t.prototype.lock=function(n){var t=this;n===undefined?t.direction=="up"?t.isLockDown=!0:t.direction=="down"?t.isLockUp=!0:(t.isLockUp=!0,t.isLockDown=!0):n=="up"?t.isLockUp=!0:n=="down"&&(t.isLockDown=!0)};t.prototype.unlock=function(){var n=this;n.isLockUp=!1;n.isLockDown=!1};t.prototype.noData=function(){var n=this;n.isData=!1};t.prototype.resetload=function(){var t=this;if(t.direction=="down"&&t.upInsertDOM)t.$domUp.css({height:"0"}).on("webkitTransitionEnd mozTransitionEnd transitionend",function(){t.loading=!1;t.upInsertDOM=!1;n(this).remove();o(t)});else t.direction=="up"&&(t.loading=!1,t.isData?(t.$domDown.html(t.opts.domDown.domRefresh),o(t)):t.$domDown.html(t.opts.domDown.domNoData))}})(window.Zepto||window.jQuery);