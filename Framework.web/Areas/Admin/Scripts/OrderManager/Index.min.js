$(function(){modules.get(enums.Modules.CACHE).setMenuDomain("订单管理",new function(){function r(){var i=$("#order_manager_input_RoleType").val();i==0?$("#order_manager_input_where_store").attr("style","display:none"):$("#order_manager_input_where_background").attr("style","display:none");try{n.bindPaginationEvent(t,{idField:"ID",loadMsg:"正在加载...",toolbar:"#order_manager_grid_tool",fit:!0,fitColumns:!0,pagination:!0,rownumbers:!0,singleSelect:!0,columns:[[{field:"ID",title:"主键",align:"center",width:100,hidden:!0},{field:"sOrderNo",title:"订单号",align:"center",width:100},{field:"sReceiver",title:"购买人",align:"center",width:100},{field:"iTotalPrice",title:"订单总价",align:"center",width:100},{field:"iType",title:"订单分类",align:"center",width:100,formatter:function(n){switch(n){case 0:n="客房";break;case 1:n="门票";break;case 2:n="周边"}return n}},{field:"sShopName",title:"店铺名称",align:"center",width:100},{field:"dBookTime",title:"下单时间",align:"center",width:100},{field:"iState",title:"状态",align:"center",width:100,formatter:function(n){switch(n){case 0:n="待付款";break;case 1:n="待使用";break;case 2:n="已核销"}return n}}]],onLoadSuccess:function(n){if(n.total>0){var i=n.rows[0].isStore;i===!1||t.datagrid("hideColumn","sShopName")}},rowStyler:function(n,t){if(t.iState===0)return"background-color:gray;color:white"}},s).pagination("select")}catch(r){n.alertErr(r.Msg)}}function u(n){var t=[];switch(n){case 0:t=[{field:"sGoodsName",title:"商品名称",align:"center",width:150},{field:"iTotalPrice",title:"总价",align:"center",width:100},{field:"dStartTime",title:"开始时间",align:"center",width:100,hidden:!0},{field:"sEndTime",title:"结束时间",align:"center",width:100,hidden:!0},{field:"iTotalTime",title:"入住时间",align:"center",width:300,formatter:function(n,t){var i=new Date(t.sEndTime.replace(/-/g,"/"));i=new Date(i.setDate(i.getDate()+1));var r=new Date(t.dStartTime.replace(/-/g,"/")),u=i.getTime()-r.getTime(),f=Math.floor(u/864e5);return"{0}入住,{1}退房,共{2}晚".format(r.Format("MM/dd"),i.Format("MM/dd"),f)}}];break;case 1:t=[{field:"sGoodsName",title:"商品名称",align:"center",width:150},{field:"iAmount",title:"数量",align:"center",width:100},{field:"iTotalPrice",title:"金额",align:"center",width:100},{field:"dStartTime",title:"票务时间",align:"center",width:100}];break;case 2:t=[{field:"sGoodsName",title:"商品名称",align:"center",width:150},{field:"iTotalPrice",title:"总价",align:"center",width:100}]}return t}function f(n,t){var i=u(n.iType);$("#order_manager_order_goods_grid").datagrid({columns:[i],fitColumns:!0});$("#order_manager_order_goods_grid").datagrid("loadData",t);$($(".datagrid-htable")[3]).css({width:"774px"});$($(".datagrid-btable")[2]).css({width:"774px"})}function e(t){var r=$("<div/>");r.dialog({title:"订单详情",width:800,height:500,cache:!1,href:"/Admin/OrderManager/ToOrderDetail",modal:!0,collapsible:!1,minimizable:!1,maximizable:!1,resizable:!1,singleSelect:!0,buttons:[{text:"关闭",iconCls:"icon-cancel",handler:function(){$(r).dialog("close")}}],onClose:function(){$(r).dialog("destroy");r=null},onLoad:function(){i.post("/Admin/OrderManager/LoadOrderDetailById",{ID:t.ID,iType:t.iType},function(n){o(n.Data.order);f(t,n.Data.orderGoods)},function(t){n.alertInfo(t.Msg)})}})}function o(n){var u=$("#order_manager_order_time"),t="",r,i;switch(n.iState){case 0:t="待付款";break;case 1:t="待使用";u.html('<td>下单时间<\/td><td id="order_manager_order_book_time"><\/td><td>付款时间<\/td><td>{0}<\/td>'.format(n.dPayTime));break;case 2:t="已核销";r='<tr id="order_manager_order_pay_time"><td>付款时间<\/td><td>{0}<\/td><td>核销时间<\/td><td>{1}<\/td><\/tr>'.format(n.dPayTime,n.dFinishTime);$("#order_manager_order_form").append(r);$("#order_manager_order_pay_time").insertAfter("#order_manager_order_time")}$("#order_manager_order_no").text(n.sOrderNo);$("#order_manager_order_status").text(t);$("#order_manager_order_book_time").text(n.dBookTime);$("#order_manager_order_client_name").text(n.sReceiver);$("#order_manager_order_client_mobile_number").text(n.sReceiverPhone);i="";i=n.iCoiCouponPrice==null||n.iCoiCouponPrice==""||n.iUsePrice==null||n.iUsePrice==""?"该订单没有使用优惠劵":"{0}元，（满{1}可用）".format(n.iCoiCouponPrice,n.iUsePrice);$("#order_manager_order_coupon").text(i);$("#order_manager_order_realPayMoney").text(n.iTotalPrice+"元");$("#order_manager_order_remark").text(n.sDescribe)}function s(r,u){try{if($("#order_manager_form").form("validate")){var f=$("#order_manager_form").serializeObject();f.PageIndex=r;f.PageSize=u;i.post("/Admin/OrderManager/LoadOrderData",f,function(n){n.Data!==null&&(t.datagrid("loadData",n.Data.Result),t.datagrid("getPager").pagination({pageNumber:r,pageSize:u,total:n.Data.MaxCount}))},function(t){n.alertErr(t.Msg)})}}catch(e){n.alertErr(e.message)}}function h(){$("#order_manager_form").on("click","#order_manager_btn_seach",function(){var i=$("#order_manager_input_startTime").val(),r=$("#order_manager_input_endTime").val();if(i!=""&&r!=""&&new Date(i)>new Date(r))return n.alertInfo("开始时间不能大于结束时间");n.search(t,!1)}).on("click","#order_manager_a_detail",function(){n.checkSelectedRow(t,e,"请至少选中一行")})}function l(){}var n=modules.get(enums.Modules.JQUERY_EASYUI),i=modules.get(enums.Modules.FUNC),t=$("#order_manager_grid");try{r();h()}catch(c){n.alertErr(c.message)}return{destroy:l}})});